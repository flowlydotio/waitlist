name: Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

env:
  NODE_VERSION: '20'

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # STAGE 1: Setup & Validation
  # ===========================================
  setup:
    name: "ğŸš€ Stage 1: Setup & Validation"
    runs-on: ubuntu-latest
    outputs:
      should-deploy-dev: ${{ steps.deployment-check.outputs.should-deploy-dev }}
      should-deploy-prod: ${{ steps.deployment-check.outputs.should-deploy-prod }}
      should-sync-to-production: ${{ steps.deployment-check.outputs.should-sync-to-production }}
      environment: ${{ steps.deployment-check.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Determine deployment strategy
        id: deployment-check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.environment }}" == "dev" ]]; then
              echo "should-deploy-dev=true" >> $GITHUB_OUTPUT
              echo "should-deploy-prod=false" >> $GITHUB_OUTPUT
              echo "should-sync-to-production=false" >> $GITHUB_OUTPUT
              echo "environment=dev" >> $GITHUB_OUTPUT
            else
              # prod environment
              echo "should-deploy-dev=false" >> $GITHUB_OUTPUT
              echo "should-deploy-prod=true" >> $GITHUB_OUTPUT
              # Always sync when deploying to prod (regardless of input)
              echo "should-sync-to-production=true" >> $GITHUB_OUTPUT
              echo "environment=prod" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-deploy-dev=true" >> $GITHUB_OUTPUT
            echo "should-deploy-prod=false" >> $GITHUB_OUTPUT
            echo "should-sync-to-production=false" >> $GITHUB_OUTPUT
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "should-deploy-dev=true" >> $GITHUB_OUTPUT
            echo "should-deploy-prod=false" >> $GITHUB_OUTPUT
            echo "should-sync-to-production=false" >> $GITHUB_OUTPUT
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy-dev=false" >> $GITHUB_OUTPUT
            echo "should-deploy-prod=true" >> $GITHUB_OUTPUT
            echo "should-sync-to-production=false" >> $GITHUB_OUTPUT
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "should-deploy-dev=false" >> $GITHUB_OUTPUT
            echo "should-deploy-prod=false" >> $GITHUB_OUTPUT
            echo "should-sync-to-production=false" >> $GITHUB_OUTPUT
            echo "environment=none" >> $GITHUB_OUTPUT
          fi

      - name: Display deployment plan
        run: |
          echo "ğŸ¯ Deployment Plan:"
          echo "  Dev Environment: ${{ steps.deployment-check.outputs.should-deploy-dev }}"
          echo "  Prod Environment: ${{ steps.deployment-check.outputs.should-deploy-prod }}"
          echo "  Sync to Production: ${{ steps.deployment-check.outputs.should-sync-to-production }}"
          echo "  Environment: ${{ steps.deployment-check.outputs.environment }}"
          echo "  Rebase: Using GitHub native 'Rebase and merge'"

  # ===========================================
  # STAGE 2: Code Quality (Parallel Jobs)
  # ===========================================
  lint-and-typecheck:
    name: "ğŸ” Lint and Type Check"
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: TypeScript type check
        run: pnpm type-check

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-results
          path: |
            eslint-results.json
            eslint-results.xml
          retention-days: 30

  security-scan:
    name: "ğŸ”’ Security Scan"
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Security audit
        run: pnpm audit --audit-level moderate

      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: |
            security-audit-results.json
          retention-days: 30

  code-quality:
    name: "ğŸ“Š Code Quality Checks"
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run ESLint with detailed reporting
        run: |
          pnpm lint --format json --output-file eslint-results.json || true
          pnpm lint --format junit --output-file eslint-results.xml || true

      - name: TypeScript type checking
        run: pnpm type-check

      - name: Upload code quality results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-results
          path: |
            eslint-results.json
            eslint-results.xml
          retention-days: 30

  performance-check:
    name: "âš¡ Performance Check"
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Analyze bundle size
        run: |
          echo "ğŸ“¦ Bundle Analysis:"
          find dist -name "*.js" -exec ls -lh {} \; | awk '{print $5, $9}' | sort -hr
          find dist -name "*.css" -exec ls -lh {} \; | awk '{print $5, $9}' | sort -hr
          
          # Check for large files
          LARGE_JS=$(find dist -name "*.js" -size +500k | wc -l)
          LARGE_CSS=$(find dist -name "*.css" -size +100k | wc -l)
          
          if [ $LARGE_JS -gt 0 ]; then
            echo "âš ï¸ Warning: Found $LARGE_JS JavaScript files larger than 500KB"
            find dist -name "*.js" -size +500k -exec ls -lh {} \;
          fi
          
          if [ $LARGE_CSS -gt 0 ]; then
            echo "âš ï¸ Warning: Found $LARGE_CSS CSS files larger than 100KB"
            find dist -name "*.css" -size +100k -exec ls -lh {} \;
          fi

  # ===========================================
  # STAGE 3: Build & Test
  # ===========================================
  build:
    name: "ğŸ—ï¸ Stage 3: Build & Test"
    runs-on: ubuntu-latest
    needs: [setup, lint-and-typecheck, security-scan, code-quality, performance-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Clear cache after install
        run: |
          pnpm store prune || true
          pnpm cache clean --force || true

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          VITE_APP_ENV: ${{ needs.setup.outputs.environment }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

      - name: Build success notification
        run: |
          echo "âœ… Build completed successfully!"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Artifacts uploaded for deployment"

  # ===========================================
  # SYNC TO PRODUCTION (Manual)
  # ===========================================
  sync-to-production:
    name: "ğŸ”„ Sync to Production"
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.should-sync-to-production == 'true'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Verify develop is ahead of main
        id: verify-sync
        run: |
          git fetch origin main develop
          DEVELOP_COMMITS=$(git rev-list --count origin/main..origin/develop)
          echo "ğŸ” Debug: DEVELOP_COMMITS = $DEVELOP_COMMITS"
          if [ $DEVELOP_COMMITS -eq 0 ]; then
            echo "â„¹ï¸ develop is not ahead of main. Nothing to sync."
            echo "should-sync=false" >> $GITHUB_OUTPUT
            echo "ğŸ” Debug: should-sync=false"
          else
            echo "âœ… develop is $DEVELOP_COMMITS commits ahead of main"
            echo "should-sync=true" >> $GITHUB_OUTPUT
            echo "ğŸ” Debug: should-sync=true"
          fi

      - name: Check for merge conflicts
        if: steps.verify-sync.outputs.should-sync == 'true'
        run: |
          # Update both branches to latest
          git fetch origin main develop
          git checkout main
          git pull origin main
          git checkout develop
          git pull origin develop
          
          # Check if merge would create conflicts by trying to merge develop into main
          git checkout main
          if ! git merge --no-commit --no-ff develop; then
            echo "âŒ Merge conflicts detected. Please resolve manually."
            git merge --abort
            exit 1
          fi
          git merge --abort
          echo "âœ… No merge conflicts detected"

      - name: Sync develop to main (Squash)
        if: steps.verify-sync.outputs.should-sync == 'true'
        run: |
          echo "ğŸ” Debug: Starting sync process"
          git checkout main
          git pull origin main
          
          # Create squash merge
          echo "ğŸ” Debug: About to merge develop into main"
          git merge --squash develop
          echo "ğŸ” Debug: Merge completed, creating commit"
          git commit -m "chore: sync develop to main for production deployment

          Synced commits from develop:
          $(git log --oneline origin/main..origin/develop --reverse | sed 's/^/  - /')
          
          Triggered by: ${{ github.actor }}"
          
          echo "ğŸ” Debug: Commit created, pushing to origin"
          git push origin main
          echo "ğŸ” Debug: Push completed successfully"

      - name: Sync success notification
        if: steps.verify-sync.outputs.should-sync == 'true'
        run: |
          echo "âœ… Successfully synced develop to main!"
          echo "Production deployment will be triggered automatically."

      - name: No sync needed notification
        if: steps.verify-sync.outputs.should-sync == 'false'
        run: |
          echo "â„¹ï¸ No sync needed - develop is already up to date with main"
          echo "Production deployment will proceed with current main branch"

  # ===========================================
  # STAGE 4: Deployment (Conditional)
  # ===========================================
  deploy-dev:
    name: "ğŸš€ Deploy Dev"
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.should-deploy-dev == 'true'
    environment: dev
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          VITE_APP_ENV: dev

      - name: Deploy to Vercel (Dev)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./

      - name: Comment PR with dev URL (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸš€ Dev deployment')
            );
            
            const devUrl = process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : 'Dev URL not available';
            
            const commentBody = `## ğŸš€ Dev deployment ready!
            
            **Dev URL:** ${devUrl}
            
            This dev deployment will be automatically updated when you push new commits to this PR.
            
            ---
            *This comment will be updated automatically.*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  deploy-prod:
    name: "ğŸš€ Deploy Prod"
    runs-on: ubuntu-latest
    needs: [setup, build, sync-to-production]
    if: needs.setup.outputs.should-deploy-prod == 'true'
    environment: prod
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          VITE_APP_ENV: prod

      - name: Deploy to Vercel (Production)
        run: |
          # Install Vercel CLI
          npm install -g vercel@latest
          
          # Set environment variables for Vercel
          export VERCEL_ORG_ID="${{ secrets.VERCEL_ORG_ID }}"
          export VERCEL_PROJECT_ID="${{ secrets.VERCEL_PROJECT_ID }}"
          
          # Deploy to production with explicit branch metadata
          vercel --prod \
            --token="${{ secrets.VERCEL_TOKEN }}" \
            --meta githubCommitSha="$(git rev-parse HEAD)" \
            --meta githubCommitAuthorName="$(git log -1 --pretty=format:'%an')" \
            --meta githubCommitAuthorLogin="$(git log -1 --pretty=format:'%an')" \
            --meta githubDeployment="1" \
            --meta githubOrg="flowly-app" \
            --meta githubRepo="waitlist" \
            --meta githubCommitOrg="flowly-app" \
            --meta githubCommitRepo="waitlist" \
            --meta githubCommitMessage="$(git log -1 --pretty=format:'%s')" \
            --meta githubCommitRef="main" \
            --yes
        env:
          GITHUB_REF: refs/heads/main
          GITHUB_HEAD_REF: ''
          GITHUB_BASE_REF: ''

  # ===========================================
  # AUTO-REVERT ON FAILURE
  # ===========================================
  auto-revert:
    name: "ğŸ”„ Auto Revert on Failure"
    runs-on: ubuntu-latest
    needs: [deploy-prod]
    if: failure() && needs.deploy-prod.result == 'failure'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Check if last commit was a sync commit
        id: check_sync
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ $LAST_COMMIT_MSG == *"sync develop to main for production deployment"* ]]; then
            echo "is_sync=true" >> $GITHUB_OUTPUT
            echo "âœ… Last commit was a sync commit, proceeding with revert"
          else
            echo "is_sync=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Last commit was not a sync commit, skipping revert"
          fi

      - name: Revert sync commit
        if: steps.check_sync.outputs.is_sync == 'true'
        run: |
          # Get the commit hash before the sync
          PREVIOUS_COMMIT=$(git log -2 --pretty=%H | tail -1)
          
          # Reset to previous commit
          git reset --hard $PREVIOUS_COMMIT
          
          # Force push to revert
          git push origin main --force
          
          echo "ğŸ”„ Reverted sync commit due to deployment failure"
          echo "Previous commit: $PREVIOUS_COMMIT"

      - name: Revert notification
        if: steps.check_sync.outputs.is_sync == 'true'
        run: |
          echo "âŒ Production deployment failed!"
          echo "ğŸ”„ Automatically reverted the sync commit"
          echo "Please check the deployment logs and fix issues before trying again"

  # ===========================================
  # PIPELINE COMPLETION
  # ===========================================
  pipeline-complete:
    name: "âœ… Pipeline Complete"
    runs-on: ubuntu-latest
    needs: [setup, build, sync-to-production, deploy-dev, deploy-prod, auto-revert]
    if: always()
    
    steps:
      - name: Pipeline Summary
        run: |
          echo "ğŸ‰ Pipeline Complete!"
          echo ""
          echo "ğŸ“Š Stage Results:"
          echo "  âœ… Stage 1 (Setup): ${{ needs.setup.result }}"
          echo "  âœ… Stage 2 (Code Quality): Completed"
          echo "  âœ… Stage 3 (Build): ${{ needs.build.result }}"
          echo ""
          echo "ğŸ”„ Sync Results:"
          echo "  Sync to Production: ${{ needs.sync-to-production.result || 'skipped' }}"
          echo ""
          echo "ğŸš€ Deployment Results:"
          echo "  Dev Environment: ${{ needs.deploy-dev.result || 'skipped' }}"
          echo "  Prod Environment: ${{ needs.deploy-prod.result || 'skipped' }}"
          echo ""
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          
          # Check if any deployment failed
          if [[ "${{ needs.deploy-dev.result }}" == "failure" || "${{ needs.deploy-prod.result }}" == "failure" ]]; then
            echo "âŒ One or more deployments failed!"
            exit 1
          else
            echo "âœ… All deployments successful!"
          fi
